{% extends 'base.html' %}
{% block title %}AI Shopping Assistant{% endblock %}

{% block additional_styles %}
.chat-container {
    height: 500px;
    border: 1px solid #e1e1e1;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: #f8f9fa;
}

.chat-input {
    display: flex;
    padding: 10px;
    background-color: white;
    border-top: 1px solid #e1e1e1;
}

.chat-input input {
    flex-grow: 1;
    border: 1px solid #ced4da;
    border-radius: 20px;
    padding: 10px 15px;
    margin-right: 10px;
}

.message {
    margin-bottom: 15px;
    max-width: 80%;
}

.message-user {
    margin-left: auto;
    background-color: #007bff;
    color: white;
    border-radius: 18px 18px 0 18px;
    padding: 10px 15px;
}

.message-assistant {
    margin-right: auto;
    background-color: #e9ecef;
    color: #212529;
    border-radius: 18px 18px 18px 0;
    padding: 10px 15px;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
    text-align: right;
}

.typing-indicator {
    display: inline-block;
    width: 50px;
}

.typing-indicator span {
    display: inline-block;
    height: 10px;
    width: 10px;
    border-radius: 50%;
    background-color: #6c757d;
    margin: 0 2px;
    animation: typing-animation 1.4s infinite ease-in-out both;
}

.typing-indicator span:nth-child(1) {
    animation-delay: 0s;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing-animation {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
}

.product-carousel {
    overflow-x: auto;
    white-space: nowrap;
    padding: 15px 5px;
    margin: 10px 0;
    scrollbar-width: thin;
}

.product-carousel::-webkit-scrollbar {
    height: 8px;
}

.product-carousel::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.product-carousel::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.product-carousel::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.product-card {
    display: inline-block;
    width: 220px;
    margin-right: 15px;
    white-space: normal;
    vertical-align: top;
    transition: transform 0.3s;
}

.product-card:hover {
    transform: translateY(-5px);
}

.product-card img {
    height: 150px;
    object-fit: cover;
}

.suggestions-container {
    display: flex;
    overflow-x: auto;
    padding: 10px 0;
    margin-bottom: 15px;
    scrollbar-width: none;
}

.suggestions-container::-webkit-scrollbar {
    display: none;
}

.suggestion-chip {
    display: inline-block;
    padding: 8px 15px;
    margin-right: 10px;
    background-color: #e9ecef;
    border-radius: 20px;
    font-size: 0.875rem;
    cursor: pointer;
    white-space: nowrap;
    transition: background-color 0.2s;
}

.suggestion-chip:hover {
    background-color: #dee2e6;
}

.welcome-bubble {
    background-color: #e9ecef;
    border-radius: 18px;
    padding: 15px 20px;
    margin-bottom: 20px;
}

.welcome-bubble h5 {
    margin-bottom: 10px;
}

.welcome-icon {
    font-size: 2.5rem;
    color: #6610f2;
    margin-bottom: 15px;
}

.assistant-status {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 0.8rem;
    color: #28a745;
}

.assistant-status .status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #28a745;
    margin-right: 5px;
}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white position-relative">
                    <h3><i class="fas fa-robot mr-2"></i> AI Shopping Assistant</h3>
                    <div class="assistant-status">
                        <span class="status-dot"></span> Online
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <!-- Welcome message -->
                            <div class="welcome-bubble">
                                <div class="text-center">
                                    <div class="welcome-icon">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <h5>Hello, I'm your AI Shopping Assistant!</h5>
                                    <p>I can help you find products, provide recommendations, answer questions about items, and more.</p>
                                    <p>Just tell me what you're looking for or try one of the suggestions below.</p>
                                </div>
                            </div>
                            
                            <!-- Messages will be added here dynamically -->
                        </div>
                        
                        <!-- Suggestions chips -->
                        <div class="suggestions-container" id="suggestionChips">
                            <div class="suggestion-chip">Show me new arrivals</div>
                            <div class="suggestion-chip">What's trending today?</div>
                            <div class="suggestion-chip">Help me find a gift</div>
                            <div class="suggestion-chip">Show me popular products</div>
                            <div class="suggestion-chip">What's on sale?</div>
                        </div>
                        
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="Ask about products or get recommendations..." class="form-control">
                            <button class="btn btn-primary rounded-circle" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Your assistant learns from your interactions to provide better recommendations over time.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-5">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-light">
                    <h5><i class="fas fa-lightbulb mr-2"></i> How Your Shopping Assistant Works</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-comments text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <h6>Natural Conversations</h6>
                            <p class="small text-muted">Chat with your assistant using everyday language about what you're looking for</p>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-brain text-success" style="font-size: 2rem;"></i>
                            </div>
                            <h6>AI-Powered Understanding</h6>
                            <p class="small text-muted">Advanced machine learning understands your preferences and needs</p>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <div class="mb-3">
                                <i class="fas fa-user-check text-info" style="font-size: 2rem;"></i>
                            </div>
                            <h6>Personalized Results</h6>
                            <p class="small text-muted">Gets smarter with each interaction to deliver tailored recommendations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const suggestionChips = document.getElementById('suggestionChips');
    
    // Load suggestions from API
    loadSuggestions();
    
    // Function to add a message to the chat
    function addMessage(text, sender, timestamp = new Date()) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender === 'user' ? 'message-user' : 'message-assistant');
        messageDiv.innerText = text;
        
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('message-time');
        timeDiv.innerText = formatTime(timestamp);
        
        const messageContainer = document.createElement('div');
        messageContainer.appendChild(messageDiv);
        messageContainer.appendChild(timeDiv);
        
        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Format time for messages
    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Show typing indicator
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.classList.add('message', 'message-assistant', 'typing-message');
        typingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return typingDiv;
    }
    
    // Remove typing indicator
    function removeTypingIndicator() {
        const typingIndicator = document.querySelector('.typing-message');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    // Add product carousel
    function addProductCarousel(products) {
        if (!products || products.length === 0) return;
        
        const carouselDiv = document.createElement('div');
        carouselDiv.classList.add('product-carousel');
        
        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.classList.add('card', 'product-card');
            
            // Create product card content
            productCard.innerHTML = `
                <a href="/view_product/${encodeURIComponent(product.Name)}">
                    <img src="${product.ImageURL}" class="card-img-top" alt="${product.Name}">
                </a>
                <div class="card-body p-2">
                    <h6 class="card-title" style="font-size: 0.9rem; height: 40px; overflow: hidden;">${product.Name}</h6>
                    <p class="card-text mb-1"><small>Brand: ${product.Brand}</small></p>
                    <p class="card-text mb-1"><small>Rating: ${product.Rating} ★</small></p>
                    <a href="/view_product/${encodeURIComponent(product.Name)}" class="btn btn-sm btn-primary">View Details</a>
                </div>
            `;
            
            carouselDiv.appendChild(productCard);
        });
        
        chatMessages.appendChild(carouselDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Send message to the backend
    function sendMessage(message) {
        // Add user message to chat
        addMessage(message, 'user');
        
        // Clear input
        chatInput.value = '';
        
        // Show typing indicator
        const typingIndicator = showTypingIndicator();
        
        // Send message to backend
        fetch('/api/ai_assistant/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remove typing indicator
            removeTypingIndicator();
            
            if (data.success) {
                // Add assistant response
                addMessage(data.response.text, 'assistant');
                
                // Add product carousel if products are returned
                if (data.response.products && data.response.products.length > 0) {
                    addProductCarousel(data.response.products);
                }
                
                // Update suggestions based on the interaction
                loadSuggestions();
            } else {
                // Add error message
                addMessage("I'm sorry, I had a problem processing your request. Could you try again?", 'assistant');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            removeTypingIndicator();
            addMessage("I'm sorry, there was an error connecting to the server. Please try again later.", 'assistant');
        });
    }
    
    // Load personalized suggestions
    function loadSuggestions() {
        fetch('/api/ai_assistant/suggestions')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    // Clear existing suggestions
                    suggestionChips.innerHTML = '';
                    
                    // Add new suggestions
                    data.suggestions.forEach(suggestion => {
                        const chipDiv = document.createElement('div');
                        chipDiv.classList.add('suggestion-chip');
                        chipDiv.innerText = suggestion;
                        chipDiv.addEventListener('click', function() {
                            sendMessage(suggestion);
                        });
                        suggestionChips.appendChild(chipDiv);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading suggestions:', error);
            });
    }
    
    // Handle send button click
    sendButton.addEventListener('click', function() {
        const message = chatInput.value.trim();
        if (message) {
            sendMessage(message);
        }
    });
    
    // Handle Enter key press
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const message = chatInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        }
    });
    
    // Handle suggestion chips
    suggestionChips.querySelectorAll('.suggestion-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            sendMessage(this.innerText);
        });
    });
});
</script>
{% endblock %}